% CONFIG %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newlength{\sectionmargin}
\newlength{\sectionpadding}
\newlength{\sectiontitlespace}
\newlength{\sectiontitlewidth}
\newlength{\sectionbodyheight}

\setlength{\sectionmargin}{3.2\baselineskip}
\setlength{\sectionpadding}{0.9em}
\setlength{\sectiontitlewidth}{0.8em}
\setlength{\sectiontitlespace}{6pt}

% HEADER %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newcommand{\sectionheadertitle}[2]{% title text, title color
    \textcolor{#2}{\MakeUppercase{\textbf{#1}}}% \small
}

\newcommand{\sectionheaderrule}[1]{% rule color
    {\color{#1}\leaders\hrule height 1pt\hfill\kern0pt}%
}

\newcommand{\sectionheadercontent}[4][\sectiontitlespace]{% title space, title text, title color, rule color
    \sectionheadertitle{#2}{#3}%
    \hspace{#1}%
    \sectionheaderrule{#4}%
}

\newcommand{\sectionheaderbox}[5][\sectiontitlespace]{% title space, header length, title text, title color, rule color
  \hbox to #2{\sectionheadercontent[#1]{#3}{#4}{#5}}%
}

% HORIZONTAL %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newenvironment{horizontalsection*}[4][\sectiontitlespace]{% title space, title text, title color, rule color
    \par\noindent%
    \sectionheadercontent[#1]{#2}{#3}{#4}%
    \par\vspace{\sectionpadding}%
}{
    \par%
}

\newenvironment{horizontalsection}[4][\sectiontitlespace]{% title space, title text, title color, rule color
    \par\noindent\addvspace{\sectionmargin}%
    \begin{horizontalsection*}[#1]{#2}{#3}{#4}%
}{
    \end{horizontalsection*}%
}

% VERTICAL %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newsavebox{\sectionbodybox}

\newcommand{\verticalsectiontitlespace}{}
\newcommand{\verticalsectiontitletext}{}
\newcommand{\verticalsectiontitlecolor}{}
\newcommand{\verticalsectionrulecolor}{}

\newenvironment{verticalsection*}[4][\sectiontitlespace]{% title space, title text, title color, rule color
    % stash args for the end block
    \def\verticalsectiontitlespace{#1}%
    \def\verticalsectiontitletext{#2}%
    \def\verticalsectiontitlecolor{#3}%
    \def\verticalsectionrulecolor{#4}%
    % reset the position
    \par\noindent%
    % Capture body into a box
    \begin{lrbox}{\sectionbodybox}%
        \begin{minipage}[t]{\dimexpr\linewidth-\sectiontitlewidth-\sectionpadding\relax}%
}{%
        \end{minipage}%
    \end{lrbox}%
    % Measure body height
    \setlength{\sectionbodyheight}{\dimexpr\ht\sectionbodybox+\dp\sectionbodybox\relax}%
    % Typeset header (left) + body (right)
    \noindent
    \begin{minipage}[t][\sectionbodyheight][t]{\sectiontitlewidth}%
        \raggedleft%
        \vspace{0pt}\ignorespaces%
        \hfill\rotatebox{90}{\sectionheaderbox[\verticalsectiontitlespace]{\sectionbodyheight}{\verticalsectiontitletext}{\verticalsectiontitlecolor}{\verticalsectionrulecolor}}%
    \end{minipage}%
    \hspace{\sectionpadding}%
    \begin{minipage}[t]{\dimexpr\linewidth-\sectiontitlewidth-\sectionpadding\relax}%
        \raggedleft%
        \vspace{0pt}\ignorespaces%
        \usebox{\sectionbodybox}%
    \end{minipage}%
    \par%
}

\newenvironment{verticalsection}[4][\sectiontitlespace]{% title space, title text, title color, rule color
    \par\noindent\addvspace{\sectionmargin}%
    \begin{verticalsection*}[#1]{#2}{#3}{#4}
}{%
    \end{verticalsection*}
}
